steps:
  - label: "Triggering pipelines"
    plugins:
      - chronotc/monorepo-diff#v2.0.4:
          diff: ".buildkite/scripts/diff"
          interpolation: false
          watch:
            # ========================== Pipeline for ECS ==========================
            - path:
                - "service/scanner/"
              config:
                command: "buildkite-agent pipeline upload service/scanner/.buildkite/pipeline.yml"
                label: ":amazon-ecs: Scanner API"
            # ========================== Pipeline for Lambdas ==========================
            - path:
                - "service/lambda/notify/"
              config:
                command: "buildkite-agent pipeline upload service/lambda/notify/.buildkite/pipeline.yml"
                label: ":aws-lambda: Lambda - Notify"
            # ========================== Pipeline for Infrastructure ==========================
            - path:
                - "infra/cloudformation/"
              config:
                command: "buildkite-agent pipeline upload infra/cloudformation/.buildkite/pipeline.yml"
                label: ":building_construction: Base Infrastructure"
  - wait

  # Tagging build last commit for diffing purpose
  - label: "Tag Build"
    if:  build.branch == 'main'
    command: "echo $(git rev-parse HEAD) > ~/last_successful_production_build"
